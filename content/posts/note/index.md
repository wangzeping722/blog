---
title: "Note"
date: 2020-01-03T16:08:31+08:00
draft: true
---

## Redis笔记

1. 为什么要用 Redis？

   答：因为传统的关系型数据库如 Mysql 已经不能适用所有的场景，比如秒杀的库存扣减，APP首页的访问流量高峰等，都很容易把数据库打崩，所以引入了Redis。

2. Redis有哪些数据结构？

   答：**String**、**Hash**、**List**、**Set**、**SortedSet**

3. 如果有大量的key需要设置同一时间过期，一般需要注意什么？

   答：如果大量的key过期时间设置的过于集中，到过期的时间点，Redis可能会出现短暂的卡顿现象。严重的话可能会引起**缓存雪崩**。

   解决：我们一般需要**在时间上加一个随机值，使得过期时间分散一些**。

4. 那你使用过分布式锁么，它是怎么一回事？

   答：先拿**setnx**来争抢锁，再用**expire**给锁加一个过期时间防止锁忘记释放。

5. 接上，如果在setnx之后执行expire之前，进程意外crash或者被重启了，怎么办？

   答：可以把 setnx、expire 两条命令合并成一个命令，进行原子操作。

6. 加入有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如何将它们全部找出来？

   答：使用 **keys** 命令可以取出指定模式的 key 列表

7. 如果这个redis正在给线上的业务提供服务，那使用keys指令会有什么问题？

   答：Redis是单线程的，keys指令会导致线程阻塞一段时间，**线上业务会被停顿**，直到指令执行完毕，服务才能恢复。

   解决：可以使用**scan**命令，scan命令可以无阻塞的提取出指定模式的key列表，但是有一定的重复概率，在客户端做一次去重九可以了。

8. 使用过Redis做异步队列么，你是怎么用的？

   答：一般使用**list**结构作为队列，**rpush**生产消息，**lpop**消费消息。当lpop没有消息的时候，要适当sleep一会再重试。

9. 如果对方追问可不可以不用sleep呢？

   答：使用**blpop**，在没有消息的时候，它会阻塞直到消息到来。

10. 如果对方接着追问能不能生产一次消费多次呢？

    答：使用**pub/sub**主题订阅者模式，可以实现 1:N​

11. 如果对方继续追问 pub/sub 有什么缺点？

    答：在消费者下线的情况下，生产的消息会丢失，得使用专业的消息队列如RocketMQ等

12. 如果对方究极TM追问Redis如何实现延时队列？

    答：使用**sortedset**，拿时间戳作为**score**，消息内容作为key，调用zadd来生产消息，消费者用**zrangebyscore**指令获取N秒前的数据，轮询进行处理。

13. Redis是怎么持久化的？服务主从数据怎么交互的？

    答：**RDB做镜像全量持久化，AOF做增量持久化**。因为RDB会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以需要AOF来配合使用。Redis本身的机制时AOF持久化开启且存在AOF时，优先加载AOF文件；AOF关闭或者AOF文件不存在时，加载RDB文件；加载AOF/RDB文件后，Redis启动成功。若AOF/RDB文件存在错误，Redis启动失败，并打印错误信息。

14. 