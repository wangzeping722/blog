---
title: "Protobuf Encoding"
date: 2019-11-22T13:23:15+08:00
draft: true
---

# protobuf的编码格式

本文档描述了protocol buffer 消息的二进制格式。你无需了解这一点即可在应用程序中使用协议缓冲区，但是了解不同的协议缓冲区格式如何影响编码消息的大小可能非常有用。



### 一个简单的Message

假设你有以下非常简单的 message 定义：

``` protobuf
message Test1 {
	optional int32 a = 1;
}
```

在一个应用程序中，你能够创建一个 `Test1` 的 message 并设置字段 `a=15`，然后你把这个 message 序列化到输出流。我们检查编码后的消息，就会看见三个字节：

``` basic
08 98 01
```

但是这代表什么意思呢？

### Base 128 Varints

要了解你上面写的简单的协议缓冲区编码，你首先需要了解 `varint` 。 `varint` 是一种使用一个或多个字节序列化整数的方法，**较小的数字占用较少的字节数**。

除了最后一个字节外，`varint` 中的每个字节都设置了最高有效位（msb），表明后面还有其他字节。每个字节的低7位用于存储数字的二进制补码。

例如，我们有数字1，它是单字节，因此未设置msb：

``` basic
0000 0001
```

再来看看300，就有一点复杂了：

``` basic
1010 1100 0000 0010
```

